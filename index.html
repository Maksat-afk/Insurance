<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±—É–Ω–∫–µ—Ä ‚Äî –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π</title>
<style>
  :root{
    --accent:#1976d2;
    --accent-pressed:#9e9e9e;
    --danger:#e53935;
    --bg:#f3f6fb;
    --card:#ffffff;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#e6eefc,#f7efe6);font-family:Inter, "Segoe UI", Roboto, sans-serif;color:#222}
  .page{max-width:1100px;margin:18px auto;padding:18px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  h1{margin:0;font-size:20px}
  .mini{background:var(--card);padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);min-width:260px}
  .mini h4{margin:0 0 8px 0;font-size:14px}
  .mini p{margin:4px 0;font-size:13px}
  .step{display:none;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 12px 30px rgba(16,24,40,0.06);margin-bottom:14px}
  .step.active{display:block}
  label{display:block;margin:8px 0 6px;font-weight:600;font-size:14px}
  input[type="text"], select{width:100%;padding:10px;border-radius:8px;border:1px solid #d9dfe9;font-size:14px}
  .row{display:flex;gap:12px}
  .col{flex:1}
  .center{display:flex;justify-content:center;align-items:center}
  button{cursor:pointer;border:0;border-radius:8px;padding:10px 14px;font-weight:700}
  .btn-primary{background:var(--accent);color:#fff}
  .btn-ghost{background:#eef2f7;color:#111;border:1px solid #d7e1f2}
  .btn-danger{background:var(--danger);color:#fff}
  .wheel-wrap{position:relative;width:100%;max-width:480px;margin:0 auto}
  #wheel{width:420px;height:420px;border-radius:50%;border:6px solid #222;background:#fff;display:block;margin:auto}
  .wheel-pointer{position:absolute; right:-10px; top:50%; transform:translateY(-50%); width:0;height:0;border-top:12px solid transparent;border-bottom:12px solid transparent;border-right:20px solid #d32f2f}
  .log{background:#fff;padding:8px;border-radius:8px;max-height:160px;overflow:auto;border:1px solid #e6edf7;margin-top:10px}
  .ins-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
  .ins-card{background:#fff;border:1px solid #e6edf7;padding:12px;border-radius:8px;display:flex;flex-direction:column;gap:8px;min-height:72px;justify-content:space-between}
  .choose-btn{background:var(--accent);color:#fff;border-radius:6px;padding:8px 10px;font-weight:700}
  .chosen{background:var(--accent-pressed);color:#fff}
  .cat-list{display:flex;flex-direction:column;gap:8px}
  .cat-card{background:#fff;border:1px solid #e6edf7;padding:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
  .stats{background:#fff;padding:16px;border-radius:10px}
  @media (max-width:720px){ #wheel{width:90vw;height:90vw} .mini{min-width:180px} .row{flex-direction:column} .ins-list{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="page">
    <header>
      <h1>–§–ò–ù–ê–ù–°–û–í–´–ô –ë–£–ù–ö–ï–† ‚Äî –ò–ì–†–ê</h1>
      <div class="mini" id="miniPanel">
        <h4>–ú–∏–Ω–∏-–æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è</h4>
        <p id="miniSavings">–°–±–µ—Ä–µ–∂–µ–Ω–∏—è: ‚Äî</p>
        <p id="miniSpendable">–î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏ —Å–µ–π—á–∞—Å: ‚Äî</p>
        <p id="miniSalary">–ó–∞—Ä–ø–ª–∞—Ç–∞ –∑–∞ —Ä–∞—É–Ω–¥: ‚Äî</p>
        <p id="miniBalance">–°—á—ë—Ç: ‚Äî</p>
      </div>
    </header>

    <div id="stepProfile" class="step active">
      <h2>1) –ü—Ä–æ—Ñ–∏–ª—å ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã</label>
      <input type="text" id="teamName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–∫–æ–º–∞–Ω–¥–∞/–∏–º—è)">
      <div class="row" style="margin-top:10px">
        <div class="col">
          <label>–ü—Ä–æ—Ñ–µ—Å—Å–∏—è</label>
          <select id="profession">
            <option value="–ü—Å–∏—Ö–æ–ª–æ–≥|200000|50000|psych">–ü—Å–∏—Ö–æ–ª–æ–≥ ‚Äî 200 000 —Ç–≥ (+50 000 —Ç–≥ –∫–∞–∂–¥—ã–π —Ä–∞—É–Ω–¥)</option>
            <option value="–§—Ä–∏–ª–∞–Ω—Å–µ—Ä|150000|35000|freel">–§—Ä–∏–ª–∞–Ω—Å–µ—Ä ‚Äî 150 000 —Ç–≥ (+35 000 —Ç–≥ –∫ –≤—ã–ø–ª–∞—Ç–µ –∫–∞–∂–¥—ã–π —Ä–∞–∑)</option>
            <option value="–ü—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å|300000|0|entre">–ü—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å ‚Äî 300 000 —Ç–≥ (—Ñ–∏–∫—Å)</option>
            <option value="–í—Ä–∞—á|250000|25000|doc">–í—Ä–∞—á ‚Äî 250 000 —Ç–≥ (+25 000 —Ç–≥ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ —Å—Ç—Ä–∞—Ö–æ–≤–æ–∫)</option>
            <option value="–í–æ–¥–∏—Ç–µ–ª—å|180000|70000|driver">–í–æ–¥–∏—Ç–µ–ª—å ‚Äî 180 000 —Ç–≥ (+70 000 —Ç–≥ –∫–∞–∂–¥—ã–µ 2 —Ä–∞—É–Ω–¥–∞)</option>
            <option value="–ü–µ–Ω—Å–∏–æ–Ω–µ—Ä|120000|0|pension">–ü–µ–Ω—Å–∏–æ–Ω–µ—Ä ‚Äî 120 000 —Ç–≥ (—É–¥–≤–æ–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 —Ä–∞—É–Ω–¥–∞)</option>
          </select>
        </div>
        <div class="col">
          <label>–ó–¥–æ—Ä–æ–≤—å–µ</label>
          <select id="health">
            <option value="–•–æ—Ä–æ—à–µ–µ|5">–•–æ—Ä–æ—à–µ–µ (+5% –∫ –ø–æ–∫—Ä—ã—Ç–∏—é)</option>
            <option value="–°—Ä–µ–¥–Ω–µ–µ|10">–°—Ä–µ–¥–Ω–µ–µ (+10% –∫ –ø–æ–∫—Ä—ã—Ç–∏—é)</option>
            <option value="–ü–ª–æ—Ö–æ–µ|15">–ü–ª–æ—Ö–æ–µ (+15% –∫ –ø–æ–∫—Ä—ã—Ç–∏—é)</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label>–ò–º—É—â–µ—Å—Ç–≤–æ (–≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–∑–º–µ—Ä —É—â–µ—Ä–±–∞)</label>
          <select id="property">
            <option value="medium|1.00">–î–æ–º —Å—Ä–µ–¥–Ω–∏–π + –º–∞—à–∏–Ω–∞ —Å—Ä–µ–¥–Ω—è—è (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
            <option value="lux|1.30">–ü–µ–Ω—Ç—Ö–∞—É—Å + –ª–∏–º—É–∑–∏–Ω (–ø–æ–≤—ã—à–µ–Ω–Ω—ã–π —É—â–µ—Ä–±)</option>
          </select>
        </div>
        <div class="col">
          <label>–°–±–µ—Ä–µ–∂–µ–Ω–∏—è</label>
          <select id="savings">
            <option value="250000|0">250 000 —Ç–≥ (–Ω–∞–ª–∏—á–Ω—ã–µ) ‚Äî 100% –¥–æ—Å—Ç—É–ø–Ω–æ</option>
            <option value="500000|60">500 000 —Ç–≥ (60% –∞–∫—Ü–∏–∏) ‚Äî –¥–æ—Å—Ç—É–ø–Ω–æ 200 000 —Ç–≥</option>
            <option value="750000|75">750 000 —Ç–≥ (75% –∞–∫—Ü–∏–∏) ‚Äî –¥–æ—Å—Ç—É–ø–Ω–æ 187 500 —Ç–≥</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–∫—Ä—É—Ç–æ–∫ (—Ä–∞—É–Ω–¥–æ–≤) ‚Äî –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å</label>
        <input id="roundsInput" type="number" value="4" min="1" max="10" />
      </div>

      <div style="margin-top:14px" class="center">
        <button class="btn-primary" onclick="applyProfile()">–î–∞–ª–µ–µ ‚Äî –ø–æ–∫—É–ø–∞—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏</button>
      </div>
    </div>

    <div id="stepInsurance" class="step">
      <h2>2) –ü–æ–∫—É–ø–∫–∞ —Å—Ç—Ä–∞—Ö–æ–≤–æ–∫ (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—É–º–º—ã)</h2>
      <p>–ù–∞–∂–º–∏—Ç–µ "–í—ã–±–∏—Ä–∞—é" —á—Ç–æ–±—ã –∫—É–ø–∏—Ç—å. –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–µ—Ç —Å–µ—Ä–∞—è, –∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—ã—á—Ç–µ—Ç—Å—è –∏–∑ –Ω–∞–ª–∏—á–Ω–æ–π —á–∞—Å—Ç–∏ —Å–±–µ—Ä–µ–∂–µ–Ω–∏–π (–Ω–µ –∏–∑ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π). –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞–ª–∏—á–Ω—ã—Ö ‚Äî –ø–æ–∫–∞–∂–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ.</p>
      <div id="insContainer" class="ins-list" style="margin-top:10px"></div>
      <div style="margin-top:10px" class="center">
        <button class="btn-primary" onclick="finishInsurances()">–ì–æ—Ç–æ–≤–æ ‚Äî –∫ –∫–æ–ª–µ—Å—É</button>
      </div>
      <div style="margin-top:8px;color:#666;font-size:13px">–î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –ø–æ–∫—É–ø–∫–∏ —Å—Ç—Ä–∞—Ö–æ–≤–æ–∫ —Å–µ–π—á–∞—Å: <span id="availableForIns">‚Äî</span></div>
    </div>

    <div id="stepWheel" class="step">
      <h2>3) –ö–æ–ª–µ—Å–æ —É—Ä–æ–≤–Ω–µ–π ‚Äî –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ</h2>
      <div class="wheel-wrap">
        <canvas id="wheel" width="420" height="420"></canvas>
        <div class="wheel-pointer"></div>
      </div>
      <div style="margin-top:10px" class="center">
        <button id="spinBtn" class="btn-primary" onclick="spinWheel()">üé≤ –ó–ê–ü–£–°–¢–ò–¢–¨ –°–û–ë–´–¢–ò–ï (–∫—Ä—É—Ç–∏—Ç—å)</button>
        <button class="btn-ghost" onclick="forceNextRound()" title="–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞—É–Ω–¥—É (–¥–ª—è —Ç–µ—Å—Ç–∞)">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å / –°–ª–µ–¥—É—é—â–∏–π</button>
      </div>

      <div id="levelInfo" style="margin-top:12px"></div>

      <div id="catBox" style="display:none;margin-top:12px">
        <h4>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—É</h4>
        <div id="catList" class="cat-list"></div>
        <div style="margin-top:8px" class="center">
          <button class="btn-primary" onclick="confirmCat()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
        </div>
      </div>

      <div class="log" id="gameLog" style="margin-top:12px"></div>
    </div>

    <div id="stepFinal" class="step">
      <h2 id="finalTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
      <div class="stats" id="finalStats"></div>
      <div style="margin-top:12px" class="center">
        <button class="btn-primary" onclick="restartAll()">–ò–≥—Ä–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
      </div>
    </div>
  </div>

<script>

const MAX_ROUNDS_DEFAULT = 4;

const FIXED_INS = [
  {name:"–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –∂–∏–∑–Ω–∏", cost:75000, coverage:65},
  {name:"–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞", cost:80000, coverage:65},
  {name:"–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –∏–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏", cost:70000, coverage:65},
  {name:"–ê–≤—Ç–æ—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞", cost:90000, coverage:65},
  {name:"–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –∂–∏–ª—å—è", cost:110000, coverage:65},
  {name:"–ë–∏–∑–Ω–µ—Å-—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞", cost:100000, coverage:65},
  {name:"–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏", cost:85000, coverage:65}
];

const LEVELS = [
  { name:"–§–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∏–π",
    cats:[
      {title:"–ü–∞–¥–µ–Ω–∏–µ –º–µ—Ç–µ–æ—Ä–∏—Ç–∞ –Ω–∞ –¥–æ–º", damage:1500000, insurance:"–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –∂–∏–ª—å—è"},
      {title:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —ç–ø–∏–¥–µ–º–∏—è (–Ω–æ–≤—ã–π —à—Ç–∞–º–º)", damage:1200000, insurance:"–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞"},
      {title:"–•–∞–∫–µ—Ä—Å–∫–∞—è –∞—Ç–∞–∫–∞ —É–Ω–∏—á—Ç–æ–∂–∏–ª–∞ –∞–∫—Ç–∏–≤—ã", damage:800000, insurance:"–ë–∏–∑–Ω–µ—Å-—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞"}
    ]
  },
  { name:"–°–ª–æ–∂–Ω—ã–π",
    cats:[
      {title:"–ö—Ä—É–ø–Ω–∞—è –æ—à–∏–±–∫–∞ –Ω–∞ —Ä–∞–±–æ—Ç–µ ‚Äî –∫–æ–º–ø–∞–Ω–∏—è —Ç–µ—Ä—è–µ—Ç –¥–µ–Ω—å–≥–∏", damage:1000000, insurance:"–ë–∏–∑–Ω–µ—Å-—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞"},
      {title:"–¢–µ–±—è —Å–±–∏–ª–∞ –º–∞—à–∏–Ω–∞ –∏ —Å–∫—Ä—ã–ª–∞—Å—å", damage:900000, insurance:"–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞"},
      {title:"–¢—è–∂–µ–ª—ã–π –ø–æ–∂–∞—Ä –≤ –≥–∞—Ä–∞–∂–µ + –∞–≤—Ç–æ", damage:750000, insurance:"–ê–≤—Ç–æ—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞"}
    ]
  },
  { name:"–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π",
    cats:[
      {title:"–¢—ã –∑–∞–±–æ–ª–µ–ª(–∞) —Ä–∞–∫–æ–º (2 —Å—Ç–∞–¥–∏—è) ‚Äî –¥–æ–ª–≥–∏–µ —Ä–∞—Å—Ö–æ–¥—ã", damage:1100000, insurance:"–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞"},
      {title:"–î–æ–º —Ä–∞–∑—Ä—É—à–µ–Ω –∑–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏–µ–º", damage:1000000, insurance:"–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –∂–∏–ª—å—è"},
      {title:"–¢—è–∂—ë–ª–∞—è —Ç—Ä–∞–≤–º–∞ ‚Äî –∏–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å", damage:900000, insurance:"–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –∏–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏"}
    ]
  },
  { name:"–ê–¥—Å–∫–∏–π",
    cats:[
      {title:"–¢–µ–±—è —Å–±–∏–ª–∞ –º–∞—à–∏–Ω–∞ ‚Äî —Ç—è–∂—ë–ª—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è", damage:1500000, insurance:"–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞"},
      {title:"–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ ‚Äî –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∫—Ä—É–ø–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞", damage:1600000, insurance:"–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏"},
      {title:"–ü–æ–ª–Ω—ã–π –∫—Ä–∞—Ö –±–∏–∑–Ω–µ—Å–∞", damage:2000000, insurance:"–ë–∏–∑–Ω–µ—Å-—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞"}
    ]
  }
];

let state = {
  teamName: '',
  profession: null,
  healthBonus: 0,
  propertyMul: 1,
  savingsTotal: 0,
  savingsStocksPercent: 0,
  savingsCash: 0,
  investedLocked: 0,
  purchasedIns: {},
  availableForIns: 0,
  maxRounds: MAX_ROUNDS_DEFAULT,
  currentRound: 0,
  log: [],
  balance: 0,
  statsCats: [],
  lostAt: null
};

function format(t){ return new Intl.NumberFormat('ru-RU').format(Math.round(t)) + ' —Ç–≥'; }
function $(id){return document.getElementById(id)}

function updateMini(){
  $('miniSavings').textContent = `–°–±–µ—Ä–µ–∂–µ–Ω–∏—è: ${format(state.savingsTotal)} (–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${format(state.investedLocked)}, –Ω–∞–ª–∏—á–Ω—ã—Ö —Å–µ–π—á–∞—Å: ${format(state.savingsCash)})`;
  $('miniSpendable').textContent = `–î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏ —Å–µ–π—á–∞—Å: ${format(state.availableForIns)}`;
  let sal = state.profession ? state.profession.baseSalary : 0;
  $('miniSalary').textContent = `–ó–∞—Ä–ø–ª–∞—Ç–∞: ${format(sal)} (–ø—Ä–∞–≤–∏–ª–∞: ${state.profession ? state.profession.name : '-'})`;
  $('miniBalance').textContent = `–°—á—ë—Ç: ${format(state.balance)}`;
}

function applyProfile(){
  const name = $('teamName').value.trim() || '–ò–≥—Ä–æ–∫';
  state.teamName = name;

  const profVal = $('profession').value.split('|');
  state.profession = {name:profVal[0], baseSalary: parseInt(profVal[1]), extra: parseInt(profVal[2]), code: profVal[3]};

  const healthVal = $('health').value.split('|');
  state.healthBonus = parseInt(healthVal[1]);

  const propVal = $('property').value.split('|');
  state.propertyMul = parseFloat(propVal[1]);

  const savVal = $('savings').value.split('|');
  state.savingsTotal = parseInt(savVal[0]);
  const stocksPercent = parseInt(savVal[1]);
  state.savingsStocksPercent = stocksPercent;
  state.savingsCash = Math.round(state.savingsTotal * (100 - stocksPercent) / 100);
  state.investedLocked = Math.round(state.savingsTotal - state.savingsCash);

  state.availableForIns = state.savingsCash;
  state.balance = 0;
  state.purchasedIns = {};
  state.statsCats = [];
  state.currentRound = 0;
  const r = parseInt($('roundsInput').value) || MAX_ROUNDS_DEFAULT;
  state.maxRounds = r;

  renderInsuranceOptions();
  updateMini();
  $('stepProfile').classList.remove('active');
  $('stepInsurance').classList.add('active');
}

function renderInsuranceOptions(){
  const container = $('insContainer'); container.innerHTML = '';
  FIXED_INS.forEach(ins=>{
    const div = document.createElement('div'); div.className='ins-card';
    const cov = Math.min(100, ins.coverage + state.healthBonus);
    div.innerHTML = `
      <div>
        <div style="font-weight:700">${ins.name}</div>
        <div style="font-size:13px;color:#555">–°—Ç–æ–∏–º–æ—Å—Ç—å: ${format(ins.cost)} ‚Ä¢ –ü–æ–∫—Ä—ã—Ç–∏–µ: ${cov}%</div>
      </div>
      <div style="text-align:right">
        <button id="insBtn_${ins.name}" class="choose-btn" onclick="toggleIns('${ins.name}')">–í—ã–±–∏—Ä–∞—é</button>
      </div>
    `;
    container.appendChild(div);
  });
  $('availableForIns').textContent = format(state.availableForIns);
}

function toggleIns(name){
  const ins = FIXED_INS.find(i=>i.name===name);
  if(!ins) return;
  const btn = $(`insBtn_${name}`);
  if(state.purchasedIns[name]){
    delete state.purchasedIns[name];
    state.availableForIns += ins.cost;
    btn.classList.remove('chosen');
    btn.textContent = '–í—ã–±–∏—Ä–∞—é';
  } else {
    if(ins.cost > state.availableForIns){
      alert('–í–∞–º –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –Ω–∞–ª–∏—á–Ω—ã—Ö –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —ç—Ç–æ–π —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏.');
      return;
    }
    state.availableForIns -= ins.cost;
    state.purchasedIns[name] = Math.min(100, ins.coverage + state.healthBonus);
    btn.classList.add('chosen');
    btn.textContent = '–í—ã–±—Ä–∞–Ω–æ';
  }
  $('availableForIns').textContent = format(state.availableForIns);
  updateMiniPanelAfterInsSelection();
}

function updateMiniPanelAfterInsSelection(){
  $('miniSpendable').textContent = `–î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏ —Å–µ–π—á–∞—Å: ${format(state.availableForIns)}`;
  $('miniBalance').textContent = `–°—á—ë—Ç: ${format(state.balance)} (–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${format(state.investedLocked)})`;
}

function finishInsurances(){
  state.balance += state.investedLocked;
  const returnedCash = state.availableForIns;
  state.balance += returnedCash;
  state.availableForIns = 0;
  state.savingsCash = 0;
  state.investedLocked = 0;

  state.currentRound = 0;
  addLog(`–ü–æ–∫—É–ø–∫–∞ —Å—Ç—Ä–∞—Ö–æ–≤–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–∞ —Å—á—ë—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ: ${format(state.balance)}.`);

  updateMini();

  $('stepInsurance').classList.remove('active');
  $('stepWheel').classList.add('active');
  drawWheel();
  startNextRound();
}

function addLog(text){
  const el = $('gameLog');
  const d = document.createElement('div');
  d.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
  el.prepend(d);
}


function computeSalaryForThisPayout(){
  const p = state.profession;
  if(!p) return 0;
  const r = state.currentRound;
  let amount = p.baseSalary;
  switch(p.code){
    case 'psych':
      amount = p.baseSalary + p.extra * r;
      break;
    case 'freel':
      amount = p.baseSalary + p.extra * r;
      break;
    case 'entre':
      amount = p.baseSalary;
      break;
    case 'doc':
      amount = p.baseSalary + p.extra * Math.max(0, r); 
      break;
    case 'driver':
      amount = p.baseSalary + ((r>0 && r%2===0) ? p.extra : 0);
      break;
    case 'pension':
      amount = p.baseSalary * ( (r>0 && r%2===0) ? 2 : 1 );
      break;
    default:
      amount = p.baseSalary;
  }
  return Math.round(amount);
}

function startNextRound(){
  state.currentRound += 1;
  if(state.currentRound > state.maxRounds){
    finishGame(true);
    return;
  }
  const salaryToPay = computeSalaryForThisPayout();
  state.balance += salaryToPay;
  addLog(`–†–∞—É–Ω–¥ ${state.currentRound}: –Ω–∞—á–∏—Å–ª–µ–Ω–∞ –∑–∞—Ä–ø–ª–∞—Ç–∞ ${format(salaryToPay)}. –ë–∞–ª–∞–Ω—Å: ${format(state.balance)}.`);
  updateMini();
}

const wheelCanvas = $('wheel');
const wctx = wheelCanvas.getContext('2d');
let spinning=false;
function drawWheel(rotation = 0){
  const pool = LEVELS;
  const n = pool.length;
  const cx = wheelCanvas.width/2, cy = wheelCanvas.height/2, r = Math.min(cx,cy)-6;
  wctx.clearRect(0,0,wheelCanvas.width,wheelCanvas.height);
  const angle = 2*Math.PI / n;
  for(let i=0;i<n;i++){
    const start = i*angle + rotation;
    wctx.beginPath(); wctx.moveTo(cx,cy); wctx.arc(cx,cy,r,start,start+angle); wctx.closePath();
    wctx.fillStyle = i%2===0?`hsl(${i*50},60%,85%)`:`hsl(${i*50+20},60%,90%)`;
    wctx.fill(); wctx.strokeStyle = '#222'; wctx.stroke();
    wctx.save(); wctx.translate(cx,cy); wctx.rotate(start + angle/2); wctx.fillStyle = '#111';
    wctx.textAlign = 'right'; wctx.font = `bold 14px sans-serif`; wctx.fillText(pool[i].name, r-12,6); wctx.restore();
  }
}

function spinWheel(){
  if(spinning) return;
  spinning = true;
  const n = LEVELS.length;
  const rotations = 4 + Math.floor(Math.random()*3);
  const finalIndex = Math.floor(Math.random()*n);
  const totalFrames = 90;
  let frame = 0;
  const anglePer = 2*Math.PI/n;
  const targetRotation = -(finalIndex*anglePer + anglePer/2);
  function step(){
    frame++;
    const t = frame/totalFrames;
    const ease = 1 - Math.pow(1-t,3);
    const curRot = (rotations*2*Math.PI + Math.abs(targetRotation))*ease;
    drawWheel(-curRot);
    if(frame < totalFrames) requestAnimationFrame(step);
    else {
      spinning = false;
      showLevel(finalIndex);
    }
  }
  step();
}

function showLevel(index){
  const level = LEVELS[index];
  $('levelInfo').innerHTML = `<strong>–£—Ä–æ–≤–µ–Ω—å:</strong> ${level.name}`;
  const container = $('catList'); container.innerHTML = '';
  level.cats.forEach((c,i)=>{
    const div = document.createElement('div'); div.className='cat-card';
    const btn = document.createElement('button'); btn.className='choose-btn'; btn.textContent='–í—ã–±–∏—Ä–∞—é';
    btn.onclick = ()=>{
      document.querySelectorAll('#catList .choose-btn').forEach(b=>{ b.classList.remove('chosen'); b.textContent='–í—ã–±–∏—Ä–∞—é'; });
      btn.classList.add('chosen'); btn.textContent='–í—ã–±—Ä–∞–Ω–æ';
      container.dataset.selected = i;
      container.dataset.levelIndex = index;
    };
    div.innerHTML = `<div style="flex:1"><div style="font-weight:700">${c.title}</div><div style="font-size:13px;color:#555">–£—â–µ—Ä–±: ${format(c.damage)} ‚Ä¢ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç: ${c.insurance}</div></div>`;
    div.appendChild(btn);
    container.appendChild(div);
  });
  $('catBox').style.display='block';
}

function confirmCat(){
  const container = $('catList');
  const si = container.dataset.selected;
  const li = container.dataset.levelIndex;
  if(typeof si === 'undefined'){
    alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—É (–Ω–∞–∂–º–∏—Ç–µ "–í—ã–±–∏—Ä–∞—é" —É –æ–¥–Ω–æ–π –∏–∑ –∫–∞—Ä—Ç–æ—á–µ–∫).');
    return;
  }
  const cat = LEVELS[li].cats[si];
  applyCatastrophe(cat);
  $('catBox').style.display='none';
  if(!state.lostAt){
    if(state.currentRound < state.maxRounds){
      startNextRound();
      if(state.currentRound >= state.maxRounds){
        finishGame(true);
      }
    }
  }
  updateMini();
}

function applyCatastrophe(cat){
  let damage = Math.round(cat.damage * state.propertyMul);
  const insName = cat.insurance;
  const coverage = state.purchasedIns[insName] || 0;
  const covered = Math.round(damage * coverage / 100);
  const loss = damage - covered;
  state.balance -= loss;
  state.statsCats.push({round: state.currentRound, title: cat.title, damage, covered, loss, insuranceUsed: insName, coverage});
  addLog(`–†–∞—É–Ω–¥ ${state.currentRound}: ${cat.title} ‚Äî —É—â–µ—Ä–± ${format(damage)}, –ø–æ–∫—Ä—ã—Ç–æ ${format(covered)} (${coverage}%), –ø–æ—Ç–µ—Ä–∏ ${format(loss)}. –ë–∞–ª–∞–Ω—Å: ${format(state.balance)}`);
  if(state.balance < 0){
    state.lostAt = {round: state.currentRound, cat: cat.title, balance: state.balance};
    finishGame(false);
  }
}

function forceNextRound(){
  if(state.currentRound >= state.maxRounds) { finishGame(true); return; }
  startNextRound();
}

function finishGame(won){
  $('stepWheel').classList.remove('active');
  $('stepFinal').classList.add('active');
  $('finalTitle').textContent = won ? '–í—ã –ø—Ä–æ—à–ª–∏ –∏–≥—Ä—É! –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:' : '–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:';
  const st = document.createElement('div'); st.className='';

  const chosenIns = Object.keys(state.purchasedIns).map(k=>`${k} (${state.purchasedIns[k]}%)`);
  let html = `<h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>`;
  html += `<div>–ö–æ–º–∞–Ω–¥–∞: <b>${state.teamName}</b></div>`;
  html += `<div>–ü—Ä–æ—Ñ–µ—Å—Å–∏—è: <b>${state.profession.name}</b></div>`;
  html += `<div>–ó–¥–æ—Ä–æ–≤—å–µ: <b>${$('health').value.split('|')[0]}</b> (–±–æ–Ω—É—Å –∫ –ø–æ–∫—Ä—ã—Ç–∏—é ${state.healthBonus}%)</div>`;
  html += `<div>–ò–º—É—â–µ—Å—Ç–≤–æ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—â–µ—Ä–±–∞: <b>${state.propertyMul}</b></div>`;
  html += `<div>–°–±–µ—Ä–µ–∂–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ: <b>${format(state.savingsTotal)}</b></div>`;
  html += `<div>–ö—É–ø–ª–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏: <b>${chosenIns.length?chosenIns.join(', '):'–ù–µ—Ç'}</b></div>`;
  html += `<h3 style="margin-top:10px">–§–∏–Ω–∞–Ω—Å—ã</h3>`;
  html += `<div>–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: <b>${format(state.balance)}</b></div>`;
  html += `<div>–ü—Ä–æ—à–µ–¥—à–∏–µ —Ä–∞—É–Ω–¥—ã: <b>${state.currentRound}</b> –∏–∑ ${state.maxRounds}</div>`;
  if(!won){
    html += `<div style="color:var(--danger)"><b>–í—ã –¥–æ—à–ª–∏ –¥–æ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞: ${format(state.lostAt.balance)} –≤ —Ä–∞—É–Ω–¥–µ ${state.lostAt.round} (—Å–æ–±—ã—Ç–∏–µ: ${state.lostAt.cat})</b></div>`;
  }
  html += `<h3 style="margin-top:12px">–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—ã</h3>`;
  if(state.statsCats.length===0) html += `<div>–ù–∏ –æ–¥–Ω–æ–π –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—ã –Ω–µ –≤—ã–±—Ä–∞–Ω–æ.</div>`;
  else {
    html += `<ul>`;
    state.statsCats.forEach(s=>{
      html += `<li>–†–∞—É–Ω–¥ ${s.round}: ${s.title} ‚Äî —É—â–µ—Ä–± ${format(s.damage)}, –ø–æ–∫—Ä—ã—Ç–æ ${format(s.covered)}, –ø–æ—Ç–µ—Ä–∏ ${format(s.loss)}</li>`;
    });
    html += `</ul>`;
  }
  $('finalStats').innerHTML = html;
}

function restartAll(){
  state = {
    teamName: '',
    profession: null,
    healthBonus: 0,
    propertyMul: 1,
    savingsTotal: 0,
    savingsStocksPercent: 0,
    savingsCash: 0,
    investedLocked: 0,
    purchasedIns: {},
    availableForIns: 0,
    maxRounds: MAX_ROUNDS_DEFAULT,
    currentRound: 0,
    log: [],
    balance: 0,
    statsCats: [],
    lostAt: null
  };
  $('teamName').value=''; $('stepFinal').classList.remove('active'); $('stepWheel').classList.remove('active');
  $('stepProfile').classList.add('active');
  $('gameLog').innerHTML=''; $('finalStats').innerHTML='';
  updateMini();
  drawWheel();
}

function updateMiniInitial(){ 
  $('miniSavings').textContent = '–°–±–µ—Ä–µ–∂–µ–Ω–∏—è: ‚Äî';
  $('miniSpendable').textContent= '–î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏ —Å–µ–π—á–∞—Å: ‚Äî';
  $('miniSalary').textContent = '–ó–∞—Ä–ø–ª–∞—Ç–∞: ‚Äî';
  $('miniBalance').textContent = '–°—á—ë—Ç: ‚Äî';
}
updateMiniInitial();
drawWheel();

</script>
</body>
</html>
